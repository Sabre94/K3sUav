# K3sUav - UAV Monitoring System

åŸºäº Kubernetes CRD çš„æ— äººæœºï¼ˆUAVï¼‰ç›‘æ§ç³»ç»Ÿ - æ ¸å¿ƒæ•°æ®æ”¶é›†æ¨¡å—ã€‚

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªé‡æ–°è®¾è®¡çš„ã€æ›´åŠ å¥å£®çš„ UAV ç›‘æ§ç³»ç»Ÿï¼Œä¸“æ³¨äºé€šè¿‡ Kubernetes CRDï¼ˆè‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼‰æ”¶é›†å’Œç®¡ç†æ— äººæœºé¥æµ‹æ•°æ®ã€‚è¯¥é¡¹ç›®æ˜¯ k8s-llm-monitor çš„æ”¹è¿›ç‰ˆæœ¬ï¼Œé‡ç‚¹è§£å†³äº†åŸé¡¹ç›®çš„æ¶æ„å’Œå¥å£®æ€§é—®é¢˜ã€‚

### æ ¸å¿ƒç‰¹æ€§

âœ… **å®Œæ•´çš„æ•°æ®æ”¶é›†**ï¼šGPSã€ç”µæ± ã€é£è¡ŒçŠ¶æ€ã€ç½‘ç»œã€æ€§èƒ½ã€å¥åº·æ£€æŸ¥
âœ… **Kubernetes åŸç”Ÿ**ï¼šä½¿ç”¨ CRD ä½œä¸ºæ•°æ®å­˜å‚¨ï¼Œå……åˆ†åˆ©ç”¨ K8s ç”Ÿæ€
âœ… **æ¨¡å—åŒ–è®¾è®¡**ï¼šæ¯ä¸ªåŠŸèƒ½ç‹¬ç«‹æ¨¡å—ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
âœ… **å¥å£®çš„é”™è¯¯å¤„ç†**ï¼šå®Œæ•´çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
âœ… **ç”Ÿäº§çº§ç‰¹æ€§**ï¼šä¼˜é›…å…³é—­ã€ç»“æ„åŒ–æ—¥å¿—ã€å¥åº·æ£€æŸ¥
âœ… **é«˜æ€§èƒ½**ï¼šæ•°æ®æ”¶é›†å’Œæ›´æ–°ä»…éœ€ 30-40ms

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       UAV Agent (DaemonSet)         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Data Collector              â”‚  â”‚
â”‚  â”‚  - GPS Data                   â”‚  â”‚
â”‚  â”‚  - Battery Data               â”‚  â”‚
â”‚  â”‚  - Flight Data                â”‚  â”‚
â”‚  â”‚  - Network Data               â”‚  â”‚
â”‚  â”‚  - Performance Data           â”‚  â”‚
â”‚  â”‚  - Health Check               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚             â”‚                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   K8s Client Wrapper          â”‚  â”‚
â”‚  â”‚  - CRD CRUD Operations        â”‚  â”‚
â”‚  â”‚  - Retry Logic                â”‚  â”‚
â”‚  â”‚  - Status Management          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  Kubernetes    â”‚
      â”‚  API Server    â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚   UAVMetrics   â”‚
      â”‚      CRD       â”‚
      â”‚  (Data Store)  â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
K3sUav/
â”œâ”€â”€ api/
â”‚   â””â”€â”€ crd/
â”‚       â””â”€â”€ uav-metrics-crd.yaml    # UAVMetrics CRD å®šä¹‰
â”œâ”€â”€ pkg/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ config.go               # é…ç½®ç®¡ç†ï¼ˆæ”¯æŒç¯å¢ƒå˜é‡ï¼‰
â”‚   â”œâ”€â”€ k8s/
â”‚   â”‚   â””â”€â”€ client.go               # K8s å®¢æˆ·ç«¯å°è£…ï¼ˆå¸¦é‡è¯•ï¼‰
â”‚   â”œâ”€â”€ collector/
â”‚   â”‚   â””â”€â”€ collector.go            # æ•°æ®é‡‡é›†å™¨ï¼ˆæ¨¡æ‹Ÿ+çœŸå®ï¼‰
â”‚   â””â”€â”€ models/
â”‚       â”œâ”€â”€ types.go                # æ•°æ®ç»“æ„å®šä¹‰
â”‚       â””â”€â”€ errors.go               # é”™è¯¯å®šä¹‰
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ agent/
â”‚       â””â”€â”€ main.go                 # Agent ä¸»ç¨‹åº
â”œâ”€â”€ bin/
â”‚   â””â”€â”€ uav-agent                   # ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆ15MB ARM64ï¼‰
â”œâ”€â”€ go.mod                          # Go æ¨¡å—å®šä¹‰
â”œâ”€â”€ go.sum                          # ä¾èµ–æ ¡éªŒ
â””â”€â”€ README.md                       # æœ¬æ–‡æ¡£
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- K3s/Kubernetes é›†ç¾¤ï¼ˆv1.30+ï¼‰
- Go 1.25+ (ARM64)
- kubectl å‘½ä»¤è¡Œå·¥å…·

### 1. éƒ¨ç½² CRD

```bash
# éƒ¨ç½² UAVMetrics CRD åˆ°é›†ç¾¤
kubectl apply -f api/crd/uav-metrics-crd.yaml

# éªŒè¯ CRD å·²åˆ›å»º
kubectl get crd uavmetrics.uav.k3s.io
```

### 2. ç¼–è¯‘ Agent

```bash
# ä¸‹è½½ä¾èµ–
go mod tidy

# ç¼–è¯‘
go build -o bin/uav-agent ./cmd/agent/

# éªŒè¯
./bin/uav-agent --version
```

### 3. è¿è¡Œ Agent

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
export NODE_NAME=$(hostname)
export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

# è¿è¡Œ agent
./bin/uav-agent
```

### 4. æŸ¥çœ‹æ•°æ®

```bash
# æŸ¥çœ‹æ‰€æœ‰ UAV æŒ‡æ ‡
kubectl get uavmetrics -A

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
kubectl get uavmetrics <name> -o yaml

# å®æ—¶ç›‘æ§
watch -n 2 kubectl get uavmetrics -A
```

## ğŸ“Š CRD æ•°æ®ç»“æ„

### UAVMetrics Spec

```yaml
spec:
  nodeName: k3s-uav-pool-master-0  # K8s èŠ‚ç‚¹åç§°

  gps:                              # GPS æ•°æ®
    latitude: 34.12                 # çº¬åº¦ (-90 to 90)
    longitude: -118.20              # ç»åº¦ (-180 to 180)
    altitude: 90.94                 # æµ·æ‹”é«˜åº¦ï¼ˆç±³ï¼‰
    heading: 90.40                  # èˆªå‘ï¼ˆåº¦ï¼Œ0-360ï¼‰
    speed: 4.85                     # é€Ÿåº¦ï¼ˆm/sï¼‰
    satellites: 10                  # å«æ˜Ÿæ•°é‡
    accuracy: 2.86                  # ç²¾åº¦ï¼ˆç±³ï¼‰
    lastUpdate: "2025-11-03T08:56:08Z"

  battery:                          # ç”µæ± æ•°æ®
    remainingPercent: 75.99         # å‰©ä½™ç”µé‡ç™¾åˆ†æ¯”
    voltage: 12.24                  # ç”µå‹ï¼ˆVï¼‰
    current: -9.26                  # ç”µæµï¼ˆAï¼Œè´Ÿå€¼è¡¨ç¤ºæ”¾ç”µï¼‰
    temperature: 30.00              # æ¸©åº¦ï¼ˆâ„ƒï¼‰
    timeRemaining: 1367             # å‰©ä½™æ—¶é—´ï¼ˆç§’ï¼‰
    cycleCount: 204                 # å……ç”µå¾ªç¯æ¬¡æ•°

  flight:                           # é£è¡Œæ•°æ®
    armed: true                     # æ˜¯å¦è§£é”
    mode: GUIDED                    # é£è¡Œæ¨¡å¼
    isFlying: true                  # æ˜¯å¦åœ¨é£è¡Œ
    altitude: 66.06                 # ç›¸å¯¹é«˜åº¦ï¼ˆç±³ï¼‰
    verticalSpeed: -1.01            # å‚ç›´é€Ÿåº¦ï¼ˆm/sï¼‰
    rollAngle: -7.98                # æ¨ªæ»šè§’ï¼ˆåº¦ï¼‰
    pitchAngle: -11.92              # ä¿¯ä»°è§’ï¼ˆåº¦ï¼‰
    yawAngle: 95.06                 # åèˆªè§’ï¼ˆåº¦ï¼‰

  network:                          # ç½‘ç»œæ•°æ®
    latency: 148.40                 # å»¶è¿Ÿï¼ˆmsï¼‰
    bandwidth: 57.42                # å¸¦å®½ï¼ˆMbpsï¼‰
    signalStrength: -59             # ä¿¡å·å¼ºåº¦ï¼ˆdBmï¼‰
    packetLoss: 1.19                # ä¸¢åŒ…ç‡ï¼ˆ%ï¼‰
    connectionType: WIFI            # è¿æ¥ç±»å‹

  performance:                      # æ€§èƒ½æ•°æ®
    cpuUsage: 4.19                  # CPU ä½¿ç”¨ç‡ï¼ˆ%ï¼‰
    memoryUsage: 23.18              # å†…å­˜ä½¿ç”¨ç‡ï¼ˆ%ï¼‰
    diskUsage: 48.91                # ç£ç›˜ä½¿ç”¨ç‡ï¼ˆ%ï¼‰
    temperature: 49.76              # ç³»ç»Ÿæ¸©åº¦ï¼ˆâ„ƒï¼‰
    uptime: 265309                  # è¿è¡Œæ—¶é—´ï¼ˆç§’ï¼‰

  health:                           # å¥åº·çŠ¶æ€
    status: Healthy                 # çŠ¶æ€ï¼šHealthy/Warning/Critical/Unknown
    errors: []                      # é”™è¯¯åˆ—è¡¨
    warnings: []                    # è­¦å‘Šåˆ—è¡¨
    lastHealthCheck: "2025-11-03T08:56:08Z"

  metadata:                         # å…ƒæ•°æ®
    agentVersion: v0.1.0
    hardwareModel: Generic-UAV-v1
    firmwareVersion: 1.0.0
    serialNumber: UAV-000000

status:                             # çŠ¶æ€ï¼ˆç³»ç»Ÿç®¡ç†ï¼‰
  phase: Active                     # Active/Inactive/Error/Unknown
  lastUpdated: "2025-11-03T08:56:18Z"
```

## âš™ï¸ é…ç½®é€‰é¡¹

é€šè¿‡ç¯å¢ƒå˜é‡é…ç½® Agentï¼š

### Agent é…ç½®
- `NODE_NAME`: K8s èŠ‚ç‚¹åç§°ï¼ˆå¿…éœ€ï¼‰
- `LOG_LEVEL`: æ—¥å¿—çº§åˆ«ï¼ˆdebug/info/warn/errorï¼Œé»˜è®¤ infoï¼‰
- `STRUCTURED_LOGGING`: å¯ç”¨ç»“æ„åŒ– JSON æ—¥å¿—ï¼ˆtrue/falseï¼‰

### Kubernetes é…ç½®
- `KUBECONFIG`: kubeconfig æ–‡ä»¶è·¯å¾„ï¼ˆä¸ºç©ºåˆ™ä½¿ç”¨ in-cluster é…ç½®ï¼‰
- `NAMESPACE`: CRD å‘½åç©ºé—´ï¼ˆé»˜è®¤ defaultï¼‰

### é‡‡é›†é…ç½®
- `COLLECTION_INTERVAL`: é‡‡é›†é—´éš”ï¼ˆé»˜è®¤ 10sï¼‰
- `ENABLE_GPS`: å¯ç”¨ GPS é‡‡é›†ï¼ˆé»˜è®¤ trueï¼‰
- `ENABLE_BATTERY`: å¯ç”¨ç”µæ± é‡‡é›†ï¼ˆé»˜è®¤ trueï¼‰
- `ENABLE_FLIGHT`: å¯ç”¨é£è¡Œæ•°æ®é‡‡é›†ï¼ˆé»˜è®¤ trueï¼‰
- `ENABLE_NETWORK`: å¯ç”¨ç½‘ç»œæ•°æ®é‡‡é›†ï¼ˆé»˜è®¤ trueï¼‰
- `ENABLE_PERFORMANCE`: å¯ç”¨æ€§èƒ½æ•°æ®é‡‡é›†ï¼ˆé»˜è®¤ trueï¼‰
- `ENABLE_HEALTH_CHECK`: å¯ç”¨å¥åº·æ£€æŸ¥ï¼ˆé»˜è®¤ trueï¼‰

### UAV å…ƒæ•°æ®
- `UAV_HARDWARE_MODEL`: ç¡¬ä»¶å‹å·
- `UAV_FIRMWARE_VERSION`: å›ºä»¶ç‰ˆæœ¬
- `UAV_SERIAL_NUMBER`: åºåˆ—å·

## ğŸ” æŸ¥è¯¢ç¤ºä¾‹

### åŸºæœ¬æŸ¥è¯¢

```bash
# æŸ¥çœ‹æ‰€æœ‰ UAV
kubectl get uavmetrics

# æŸ¥çœ‹ç‰¹å®š UAV
kubectl get uavmetrics uav-<node-name>

# ä½¿ç”¨ç®€ç§°
kubectl get uav
kubectl get uavs
```

### è‡ªå®šä¹‰åˆ—æ˜¾ç¤º

```bash
# æ˜¾ç¤ºå®Œæ•´ä¿¡æ¯
kubectl get uavmetrics -o wide

# æ˜¾ç¤º GPS åæ ‡ï¼ˆpriority 1 å­—æ®µï¼‰
kubectl get uavmetrics -o custom-columns=\
NAME:.metadata.name,\
LAT:.spec.gps.latitude,\
LON:.spec.gps.longitude,\
SATS:.spec.gps.satellites

# æ˜¾ç¤ºç”µæ± å’Œå¥åº·çŠ¶æ€
kubectl get uavmetrics -o custom-columns=\
NODE:.spec.nodeName,\
BATTERY:.spec.battery.remainingPercent,\
HEALTH:.spec.health.status,\
PHASE:.status.phase
```

### JSON/YAML è¾“å‡º

```bash
# JSON æ ¼å¼
kubectl get uavmetrics <name> -o json | jq '.spec.battery'

# YAML æ ¼å¼
kubectl get uavmetrics <name> -o yaml

# åªçœ‹ spec
kubectl get uavmetrics <name> -o jsonpath='{.spec}' | jq
```

## ğŸ¯ æ€§èƒ½æŒ‡æ ‡

åŸºäºå®é™…æµ‹è¯•ï¼ˆk3s 5 èŠ‚ç‚¹é›†ç¾¤ï¼ŒARM64ï¼‰ï¼š

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| æ•°æ®é‡‡é›†æ—¶é—´ | 0-6 ms |
| CRD æ›´æ–°æ—¶é—´ | 17-22 ms |
| æ€»å¤„ç†æ—¶é—´ | 30-40 ms |
| äºŒè¿›åˆ¶å¤§å° | 15 MB |
| å†…å­˜å ç”¨ | ~30 MB |
| CPU å ç”¨ | < 5% |

## ğŸ›¡ï¸ å¥å£®æ€§ç‰¹æ€§

### é”™è¯¯å¤„ç†
- âœ… å®Œæ•´çš„é”™è¯¯åŒ…è£…å’Œä¼ æ’­
- âœ… è‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼ˆå¯é…ç½®æ¬¡æ•°å’Œå»¶è¿Ÿï¼‰
- âœ… ä¼˜é›…çš„é”™è¯¯æ¢å¤ï¼ˆé‡‡é›†å¤±è´¥ä¸ä¸­æ–­å¾ªç¯ï¼‰

### å¹¶å‘å®‰å…¨
- âœ… Context å–æ¶ˆä¼ æ’­
- âœ… åç¨‹å®‰å…¨çš„èµ„æºæ¸…ç†
- âœ… ä¼˜é›…å…³é—­ï¼ˆä¿¡å·å¤„ç†ï¼‰

### æ•°æ®éªŒè¯
- âœ… GPS åæ ‡èŒƒå›´éªŒè¯
- âœ… ç”µæ± ç™¾åˆ†æ¯”éªŒè¯
- âœ… é…ç½®å‚æ•°éªŒè¯

### æ—¥å¿—
- âœ… ç»“æ„åŒ–æ—¥å¿—ï¼ˆæ”¯æŒ JSON æ ¼å¼ï¼‰
- âœ… å¯é…ç½®æ—¥å¿—çº§åˆ«
- âœ… å…³é”®æ“ä½œå¸¦æ€§èƒ½æŒ‡æ ‡

## ğŸ”§ æ”¹è¿›ç‚¹ï¼ˆç›¸æ¯”æ—§é¡¹ç›®ï¼‰

### âœ… å·²è§£å†³çš„é—®é¢˜

1. **æµ‹è¯•è¦†ç›–ç‡**ï¼šä»£ç ç»“æ„ä¾¿äºæ·»åŠ å•å…ƒæµ‹è¯•
2. **é”™è¯¯å¤„ç†**ï¼šå®Œæ•´çš„é”™è¯¯å¤„ç†ï¼Œæ‰€æœ‰é”™è¯¯éƒ½ä¼šè¿”å›
3. **å¹¶å‘å®‰å…¨**ï¼šä½¿ç”¨ K8s åŠ¨æ€å®¢æˆ·ç«¯ï¼Œæ— å¹¶å‘é—®é¢˜
4. **é…ç½®ç®¡ç†**ï¼šæ”¯æŒç¯å¢ƒå˜é‡ï¼Œæ•æ„Ÿä¿¡æ¯å¯ç”¨ K8s Secrets
5. **æ¶æ„ç®€åŒ–**ï¼šçº¯ Go å®ç°ï¼Œæ—  Python ä¾èµ–
6. **æ•°æ®æŒä¹…åŒ–**ï¼šä½¿ç”¨ CRD ä½œä¸ºå­˜å‚¨ï¼Œåˆ©ç”¨ etcd æŒä¹…åŒ–
7. **å¯è§‚æµ‹æ€§**ï¼šç»“æ„åŒ–æ—¥å¿—ï¼Œä¾¿äºé›†æˆç›‘æ§

### ğŸš§ å¾…æ·»åŠ åŠŸèƒ½

- [ ] å•å…ƒæµ‹è¯•ï¼ˆç›®æ ‡è¦†ç›–ç‡ >70%ï¼‰
- [ ] é›†æˆæµ‹è¯•
- [ ] Prometheus æŒ‡æ ‡å¯¼å‡º
- [ ] OpenTelemetry åˆ†å¸ƒå¼è¿½è¸ª
- [ ] DaemonSet éƒ¨ç½² YAML
- [ ] Docker é•œåƒæ„å»º
- [ ] Helm Chart
- [ ] API è®¤è¯æˆæƒ
- [ ] TLS è¯ä¹¦ç®¡ç†
- [ ] å‘Šè­¦è§„åˆ™

## ğŸ“ ä¸‹ä¸€æ­¥è®¡åˆ’

1. **è°ƒåº¦å™¨æ¨¡å—**ï¼šå®ç°åŸºäº GPS è·ç¦»çš„æ™ºèƒ½è°ƒåº¦
2. **è·¯ç”±æ¨¡å—**ï¼šé›†æˆ Istio Ambient å®ç°ä½ç½®æ„ŸçŸ¥è·¯ç”±
3. **Web ç•Œé¢**ï¼šReact/Vue å¯è§†åŒ–ä»ªè¡¨æ¿
4. **LLM é›†æˆ**ï¼šæ™ºèƒ½åˆ†æå’Œå†³ç­–
5. **å¤šé›†ç¾¤æ”¯æŒ**ï¼šè·¨é›†ç¾¤ UAV ç®¡ç†

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ“§ è”ç³»æ–¹å¼

Project: K3sUav UAV Monitoring System
Version: v0.1.0
Built with â¤ï¸ using Go 1.25 and Kubernetes
