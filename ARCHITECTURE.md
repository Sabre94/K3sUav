# K3sUav ç³»ç»Ÿæ¶æ„æ–‡æ¡£

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

K3sUav æ˜¯ä¸€ä¸ªåŸºäº Kubernetes çš„æ™ºèƒ½æ— äººæœºç®¡ç†ç³»ç»Ÿï¼ŒåŒ…å«ä¸¤å¤§æ ¸å¿ƒç»„ä»¶ï¼š

1. **UAV Agent** - æ•°æ®é‡‡é›†æ¨¡å—ï¼ˆDaemonSetï¼‰
2. **UAV Scheduler** - æ™ºèƒ½è°ƒåº¦æ¨¡å—ï¼ˆDeploymentï¼‰

## ğŸ—ï¸ æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      K3s é›†ç¾¤                                     â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   UAV Agent     â”‚                     â”‚  UAV Scheduler  â”‚    â”‚
â”‚  â”‚  (DaemonSet)    â”‚â”€â”€â”€â–º UAVMetrics â—„â”€â”€â”€â”‚  (Deployment)   â”‚    â”‚
â”‚  â”‚   æ¯èŠ‚ç‚¹1ä¸ª      â”‚     CRD (etcd)     â”‚    å•å‰¯æœ¬        â”‚    â”‚
â”‚  â”‚                 â”‚                     â”‚                 â”‚    â”‚
â”‚  â”‚  æ•°æ®é‡‡é›†å™¨      â”‚                     â”‚  è°ƒåº¦å†³ç­–å¼•æ“    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚          â”‚                                        â”‚              â”‚
â”‚          â”‚                                        â”‚              â”‚
â”‚          â–¼                                        â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  GPS/Battery    â”‚                     â”‚   User Pods     â”‚    â”‚
â”‚  â”‚  Network/Health â”‚                     â”‚ (è°ƒåº¦åˆ°æœ€ä¼˜èŠ‚ç‚¹) â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ ç»„ä»¶è¯¦è§£

### 1ï¸âƒ£ UAV Agent (æ•°æ®é‡‡é›†å™¨)

**éƒ¨ç½²æ–¹å¼**: DaemonSetï¼ˆæ¯ä¸ªèŠ‚ç‚¹ä¸€ä¸ª Podï¼‰

**ä¸»è¦èŒè´£**:
- é‡‡é›†èŠ‚ç‚¹çš„ UAV é¥æµ‹æ•°æ®
- å°†æ•°æ®å†™å…¥ UAVMetrics CRD
- æ¯ 10 ç§’æ›´æ–°ä¸€æ¬¡æ•°æ®

**é‡‡é›†æ•°æ®ç±»å‹**:

| ç±»å‹ | æ•°æ®é¡¹ | è¯´æ˜ |
|------|--------|------|
| **GPS** | çº¬åº¦ã€ç»åº¦ã€é«˜åº¦ã€é€Ÿåº¦ã€èˆªå‘ã€å«æ˜Ÿæ•° | ä½ç½®ä¿¡æ¯ |
| **Battery** | ç”µé‡ç™¾åˆ†æ¯”ã€ç”µå‹ã€ç”µæµã€æ¸©åº¦ | ç”µæ± çŠ¶æ€ |
| **Flight** | é£è¡Œæ¨¡å¼ã€è§£é”çŠ¶æ€ã€å§¿æ€è§’åº¦ | é£è¡ŒçŠ¶æ€ |
| **Network** | å»¶è¿Ÿã€å¸¦å®½ã€ä¿¡å·å¼ºåº¦ã€ä¸¢åŒ…ç‡ | ç½‘ç»œè´¨é‡ |
| **Performance** | CPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨ç‡ | ç³»ç»Ÿæ€§èƒ½ |
| **Health** | å¥åº·çŠ¶æ€ã€é”™è¯¯ã€è­¦å‘Š | å¥åº·æ£€æŸ¥ |

**ä»£ç ç»“æ„**:
```
cmd/agent/main.go               # ä¸»ç¨‹åºå…¥å£
pkg/collector/collector.go      # æ•°æ®é‡‡é›†é€»è¾‘
pkg/k8s/client.go               # CRD æ“ä½œå°è£…
pkg/models/types.go             # æ•°æ®æ¨¡å‹å®šä¹‰
```

**éƒ¨ç½²æ–‡ä»¶**: `deploy/agent-daemonset.yaml`

---

### 2ï¸âƒ£ UAV Scheduler (æ™ºèƒ½è°ƒåº¦å™¨)

**éƒ¨ç½²æ–¹å¼**: Deploymentï¼ˆå•å‰¯æœ¬ï¼‰

**ä¸»è¦èŒè´£**:
- ç›‘å¬æœªè°ƒåº¦çš„ Podï¼ˆ`spec.schedulerName=uav-scheduler`ï¼‰
- è¯»å–æ‰€æœ‰èŠ‚ç‚¹çš„ UAVMetrics æ•°æ®
- ä½¿ç”¨å¯æ’æ‹”ç®—æ³•ä¸ºæ¯ä¸ªèŠ‚ç‚¹è¯„åˆ†
- å°† Pod ç»‘å®šåˆ°è¯„åˆ†æœ€é«˜çš„èŠ‚ç‚¹

**è°ƒåº¦æµç¨‹**:

```
1. Watch Pod
   â†“
2. Get UAVMetrics (æ‰€æœ‰èŠ‚ç‚¹)
   â†“
3. æ‰§è¡Œç®—æ³•
   â”œâ”€â”€ Filter (è¿‡æ»¤ä¸åˆæ ¼èŠ‚ç‚¹)
   â””â”€â”€ Score  (ä¸ºæ¯ä¸ªèŠ‚ç‚¹æ‰“åˆ† 0-100)
   â†“
4. Sort (æŒ‰åˆ†æ•°æ’åº)
   â†“
5. Bind (ç»‘å®šåˆ°æœ€é«˜åˆ†èŠ‚ç‚¹)
```

**ä»£ç ç»“æ„**:
```
cmd/scheduler/main.go                   # ä¸»ç¨‹åºå…¥å£
pkg/scheduler/scheduler.go              # æ ¸å¿ƒè°ƒåº¦é€»è¾‘
pkg/scheduler/algorithm/
  â”œâ”€â”€ interface.go                      # ç®—æ³•æ¥å£å®šä¹‰
  â”œâ”€â”€ distance_based.go                 # è·ç¦»ç®—æ³•
  â”œâ”€â”€ battery_aware.go                  # ç”µæ± ç®—æ³•
  â”œâ”€â”€ network_latency.go                # ç½‘ç»œç®—æ³•
  â””â”€â”€ composite.go                      # ç»„åˆç®—æ³•
pkg/scheduler/registry/registry.go     # ç®—æ³•æ³¨å†Œè¡¨
pkg/scheduler/config/config.go         # é…ç½®ç®¡ç†
```

**éƒ¨ç½²æ–‡ä»¶**: `deploy/scheduler-deployment.yaml`

---

## ğŸ”Œ å¯æ’æ‹”ç®—æ³•æ¶æ„

### ç®—æ³•æ¥å£

æ‰€æœ‰è°ƒåº¦ç®—æ³•å¿…é¡»å®ç°ä»¥ä¸‹æ¥å£ï¼š

```go
type SchedulingAlgorithm interface {
    Name() string
    Filter(ctx, pod, metrics) ([]*UAVMetrics, error)  // å¯é€‰
    Score(ctx, pod, metrics) ([]NodeScore, error)     // å¿…éœ€
}
```

### å†…ç½®ç®—æ³•

| ç®—æ³•å | åŠŸèƒ½ | ä½¿ç”¨åœºæ™¯ | å‚æ•° |
|--------|------|----------|------|
| **distance-based** | åŸºäºGPSè·ç¦» | åœ°ç†ä½ç½®æ•æ„Ÿä»»åŠ¡ | `TARGET_LATITUDE`, `TARGET_LONGITUDE` |
| **battery-aware** | åŸºäºç”µæ± ç”µé‡ | é•¿æ—¶é—´è¿è¡Œä»»åŠ¡ | `MIN_BATTERY` |
| **network-latency** | åŸºäºç½‘ç»œå»¶è¿Ÿ | å®æ—¶é€šä¿¡ä»»åŠ¡ | `MAX_LATENCY` |
| **composite** | ç»„åˆå¤šä¸ªç®—æ³• | ç»¼åˆéœ€æ±‚ | æƒé‡é…ç½® |

### ç®—æ³•å·¥ä½œåŸç†

#### 1. Distance-based ç®—æ³•

**è¯„åˆ†å…¬å¼**:
```
score = 100 / (1 + distance_km)
```

**è·ç¦»è®¡ç®—**: Haversine å…¬å¼ï¼ˆçƒé¢è·ç¦»ï¼‰
```
distance = 2 * R * arcsin(âˆša)
å…¶ä¸­ R = 6371km (åœ°çƒåŠå¾„)
```

**ç¤ºä¾‹**:
- è·ç¦» 0km â†’ åˆ†æ•° 100.0
- è·ç¦» 1km â†’ åˆ†æ•° 50.0
- è·ç¦» 10km â†’ åˆ†æ•° 9.09
- è·ç¦» 100km â†’ åˆ†æ•° 0.99

#### 2. Battery-aware ç®—æ³•

**è¯„åˆ†å…¬å¼**:
```
score = battery_percent  (0-100)
```

**è¿‡æ»¤**: è‡ªåŠ¨è¿‡æ»¤ç”µé‡ä½äº `MIN_BATTERY` çš„èŠ‚ç‚¹

#### 3. Network-latency ç®—æ³•

**è¯„åˆ†å…¬å¼**:
```
score = 100 * (1 - latency / MAX_LATENCY)
```

**è¿‡æ»¤**: è‡ªåŠ¨è¿‡æ»¤å»¶è¿Ÿé«˜äº `MAX_LATENCY` çš„èŠ‚ç‚¹

#### 4. Composite ç®—æ³•

**è¯„åˆ†å…¬å¼**:
```
score = Î£(algorithm_i.score * weight_i)
```

**é»˜è®¤æƒé‡**: 60% è·ç¦» + 40% ç”µæ± 

---

## ğŸ“Š æ•°æ®æµ

### æ•°æ®å†™å…¥æµç¨‹ (Agent â†’ CRD)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UAV Agent   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ æ¯10ç§’
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Collector.Collect â”‚
â”‚  - GPS Data      â”‚
â”‚  - Battery Data  â”‚
â”‚  - Network Data  â”‚
â”‚  - Health Check  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ K8s Client       â”‚
â”‚ CreateOrUpdate   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UAVMetrics CRD   â”‚
â”‚ (å­˜å‚¨åœ¨ etcd)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®è¯»å–æµç¨‹ (Scheduler â† CRD)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Pod åˆ›å»º          â”‚
â”‚ schedulerName:   â”‚
â”‚ uav-scheduler    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Scheduler Watch  â”‚
â”‚ (ç›‘å¬æœªè°ƒåº¦Pod)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ListUAVMetrics   â”‚
â”‚ (è¯»å–æ‰€æœ‰CRD)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Algorithm.Score  â”‚
â”‚ (è®¡ç®—å„èŠ‚ç‚¹åˆ†æ•°)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Bind Pod to Node â”‚
â”‚ (ç»‘å®šåˆ°æœ€ä¼˜èŠ‚ç‚¹)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯ 1: åŸºäºè·ç¦»è°ƒåº¦

**éœ€æ±‚**: å°†è§†é¢‘æµå¤„ç† Pod è°ƒåº¦åˆ°è·ç¦»æ•°æ®ä¸­å¿ƒæœ€è¿‘çš„èŠ‚ç‚¹

**é…ç½®**:
```yaml
# ConfigMap
ALGORITHM_NAME: "distance-based"
TARGET_LATITUDE: "34.0522"   # æ•°æ®ä¸­å¿ƒåæ ‡
TARGET_LONGITUDE: "-118.2437"
```

**Pod å®šä¹‰**:
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: video-processor
spec:
  schedulerName: uav-scheduler
  containers:
  - name: processor
    image: video-processor:latest
```

**è°ƒåº¦ç»“æœ**: Pod è¢«è°ƒåº¦åˆ°è·ç¦» (34.0522, -118.2437) æœ€è¿‘çš„èŠ‚ç‚¹

---

### åœºæ™¯ 2: åŸºäºç”µæ± è°ƒåº¦

**éœ€æ±‚**: å°†é•¿æ—¶é—´ä»»åŠ¡è°ƒåº¦åˆ°ç”µé‡å……è¶³çš„èŠ‚ç‚¹

**é…ç½®**:
```yaml
# ConfigMap
ALGORITHM_NAME: "battery-aware"
MIN_BATTERY: "70.0"  # è‡³å°‘70%ç”µé‡
```

**è°ƒåº¦ç»“æœ**: åªè€ƒè™‘ç”µé‡ â‰¥70% çš„èŠ‚ç‚¹ï¼Œé€‰æ‹©ç”µé‡æœ€é«˜çš„

---

### åœºæ™¯ 3: ç»¼åˆè°ƒåº¦

**éœ€æ±‚**: å¹³è¡¡è·ç¦»å’Œç”µæ± å› ç´ 

**é…ç½®**:
```yaml
# ConfigMap
ALGORITHM_NAME: "composite"
# é»˜è®¤: 60% è·ç¦»æƒé‡ + 40% ç”µæ± æƒé‡
```

**è°ƒåº¦é€»è¾‘**:
```
æœ€ç»ˆåˆ†æ•° = 0.6 * distance_score + 0.4 * battery_score
```

---

## ğŸ” RBAC æƒé™

### UAV Agent éœ€è¦çš„æƒé™

```yaml
apiGroups: ["uav.k3s.io"]
resources: ["uavmetrics"]
verbs: ["get", "list", "create", "update", "patch"]

apiGroups: ["uav.k3s.io"]
resources: ["uavmetrics/status"]
verbs: ["update", "patch"]
```

### UAV Scheduler éœ€è¦çš„æƒé™

```yaml
apiGroups: [""]
resources: ["pods"]
verbs: ["get", "list", "watch"]

apiGroups: [""]
resources: ["pods/binding"]
verbs: ["create"]

apiGroups: ["uav.k3s.io"]
resources: ["uavmetrics"]
verbs: ["get", "list", "watch"]
```

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### Agent æ€§èƒ½

| æŒ‡æ ‡ | å€¼ |
|------|-----|
| æ•°æ®é‡‡é›†æ—¶é—´ | 0-6 ms |
| CRD æ›´æ–°æ—¶é—´ | 17-22 ms |
| æ€»å¤„ç†æ—¶é—´ | 30-40 ms |
| å†…å­˜å ç”¨ | ~30 MB |
| CPU å ç”¨ | <5% |

### Scheduler æ€§èƒ½

| æŒ‡æ ‡ | å€¼ |
|------|-----|
| è°ƒåº¦å»¶è¿Ÿ | 10-50 ms |
| ç®—æ³•æ‰§è¡Œæ—¶é—´ | <5 ms |
| å†…å­˜å ç”¨ | ~50 MB |
| CPU å ç”¨ | <10% |

### é›†ç¾¤è§„æ¨¡

å½“å‰æµ‹è¯•é…ç½®ï¼š
- èŠ‚ç‚¹æ•°: 5
- UAVMetrics CRD: 5æ¡è®°å½•
- Agent Pods: 5ä¸ª
- Scheduler Pods: 1ä¸ª

ç†è®ºæ”¯æŒè§„æ¨¡ï¼š
- èŠ‚ç‚¹æ•°: <100 (å—é™äºè°ƒåº¦å»¶è¿Ÿ)
- å¹¶å‘è°ƒåº¦: å•ä¸ªè°ƒåº¦å™¨é¡ºåºå¤„ç†

---

## ğŸš€ æ‰©å±•æ€§

### æ·»åŠ æ–°ç®—æ³•

1. **åˆ›å»ºç®—æ³•æ–‡ä»¶**: `pkg/scheduler/algorithm/my_algo.go`

```go
package algorithm

type MyAlgorithm struct {
    // å‚æ•°
}

func (a *MyAlgorithm) Name() string {
    return "my-algorithm"
}

func (a *MyAlgorithm) Score(ctx, pod, metrics) ([]NodeScore, error) {
    // è‡ªå®šä¹‰è¯„åˆ†é€»è¾‘
    scores := []NodeScore{}
    for _, m := range metrics {
        score := calculateMyScore(m)
        scores = append(scores, NodeScore{
            NodeName: m.NodeName,
            Score:    score,
            Reason:   "my reason",
        })
    }
    return scores, nil
}
```

2. **æ³¨å†Œç®—æ³•**: åœ¨ `cmd/scheduler/main.go`

```go
myAlgo := algorithm.NewMyAlgorithm()
registry.Register(myAlgo)
```

3. **ä½¿ç”¨ç®—æ³•**:

```bash
export ALGORITHM_NAME=my-algorithm
./bin/uav-scheduler
```

### æ·»åŠ æ–°æ•°æ®é‡‡é›†

1. **æ‰©å±•æ•°æ®æ¨¡å‹**: `pkg/models/types.go`

```go
type UAVMetrics struct {
    // ... ç°æœ‰å­—æ®µ
    CustomData *CustomData `json:"customData,omitempty"`
}
```

2. **å®ç°é‡‡é›†é€»è¾‘**: `pkg/collector/collector.go`

3. **æ›´æ–° CRD**: `api/crd/uav-metrics-crd.yaml`

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [README.md](./README.md) - é¡¹ç›®æ¦‚è¿°å’Œ Agent æ–‡æ¡£
- [SCHEDULER.md](./SCHEDULER.md) - è°ƒåº¦å™¨è¯¦ç»†æ–‡æ¡£
- [QUICKSTART_SCHEDULER.md](./QUICKSTART_SCHEDULER.md) - å¿«é€Ÿå…¥é—¨
- [DEPLOY.md](./DEPLOY.md) - éƒ¨ç½²æŒ‡å—
- [PROJECT_STRUCTURE.md](./PROJECT_STRUCTURE.md) - é¡¹ç›®ç»“æ„

---

## ğŸ¯ è®¾è®¡åŸåˆ™

1. **æ¨¡å—åŒ–**: Agent å’Œ Scheduler å®Œå…¨è§£è€¦
2. **å¯æ’æ‹”**: ç®—æ³•å¯çƒ­æ’æ‹”ï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç 
3. **Kubernetes åŸç”Ÿ**: å……åˆ†åˆ©ç”¨ K8s CRD å’Œ API
4. **é«˜æ€§èƒ½**: æ¯«ç§’çº§è°ƒåº¦å»¶è¿Ÿ
5. **å¯æ‰©å±•**: æ˜“äºæ·»åŠ æ–°ç®—æ³•å’Œæ•°æ®ç±»å‹

---

**ç‰ˆæœ¬**: v0.1.0
**æ›´æ–°æ—¶é—´**: 2025-11-07
**ç»´æŠ¤**: K3sUav Team
